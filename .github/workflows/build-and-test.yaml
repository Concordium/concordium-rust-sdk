name: Build and test

# This job runs
# - rustfmt and clippy linting,
# - cargo check
# - cargo test

on:
  push:
    branches:
     - main

  pull_request:

  workflow_dispatch: # allows manual trigger

env:
  RUST_FMT: 1.82

jobs:
  "lint_fmt":
    name: lint:fmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Format
        run: |
          rustup +$RUST_FMT component add rustfmt
          cargo +$RUST_FMT fmt -- --color=always --check

  "lint_doc":
    name: lint:doc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Docs
        run: |
          rustup component add rust-docs
          RUSTDOCFLAGS="-D warnings" cargo doc --no-deps --color=always

  # Check compilation of just the crate without tests and examples. This is to
  # make sure that the features are correctly set for the normal dependencies.
  "check_pure_compilation":
    name: lint:check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Check
        run: |
          cargo check --all-targets --all-features 

  "lint_clippy_test":
    name: lint:clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clippy
        run: |
          rustup component add clippy
          cargo clippy --color=always --all-targets --all-features -- -D warnings
          # Examples can be large with a lot of debug info due to tokio. So we
          # disable debug info generation.
          RUSTFLAGS="-C debuginfo=0" cargo test --all-targets --all-features
